<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GuÃ­a Comer â€“ Bagnolet</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1f2a44">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root {
    --bg: #f2f2f2;
    --card: #ffffff;
    --text: #222;
    --accent: #2ecc71;
}
body.night {
    --bg: #121212;
    --card: #1e1e1e;
    --text: #f0f0f0;
    --accent: #f39c12;
}
body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: var(--bg);
    color: var(--text);
}
header {
    background: #1f2a44;
    color: white;
    padding: 15px;
    text-align: center;
}
.controls {
    display: flex;
    gap: 8px;
    padding: 10px;
    flex-wrap: wrap;
}
select, button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: none;
}
button {
    background: var(--accent);
    color: white;
}
#map {
    height: 280px;
    margin: 10px;
    border-radius: 12px;
}
.card {
    background: var(--card);
    margin: 10px;
    padding: 15px;
    border-radius: 12px;
}
.btn {
    display: block;
    text-align: center;
    background: var(--accent);
    color: white;
    padding: 10px;
    border-radius: 8px;
    text-decoration: none;
    margin-top: 10px;
}
.small { font-size: 0.85em; opacity: .8; }
</style>
</head>

<body>

<header>
    <h2>ğŸ½ï¸ GuÃ­a Comer â€“ Bagnolet</h2>
    <p id="gpsStatus">ğŸ“ Pulsa para localizarte</p>
</header>

<div class="controls">
    <select id="tipo">
        <option value="all">ğŸ´ Todo</option>
        <option value="comida">ğŸ¥— Comida</option>
        <option value="cena">ğŸŒ™ Cena</option>
    </select>

    <select id="distancia">
        <option value="25">ğŸš¶ Hasta 25 min</option>
        <option value="10">â±ï¸ Hasta 10 min</option>
    </select>

    <button onclick="obtenerGPS()">ğŸ“ Recalcular</button>
    <button onclick="toggleNight()">ğŸŒ™</button>
</div>

<div id="map"></div>
<div id="lista"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const lugares = [
 {nombre:"Spicy Chick", tipo:"comida", lat:48.8672, lon:2.4150},
 {nombre:"Mayda Kebab", tipo:"comida", lat:48.8665, lon:2.4180},
 {nombre:"FratÃ© Italian Kitchen", tipo:"cena", lat:48.8680, lon:2.4123},
 {nombre:"Oâ€™Bois Pizza", tipo:"cena", lat:48.8635, lon:2.4171},
 {nombre:"Chez Laxmi", tipo:"cena", lat:48.8629, lon:2.4215},
 {nombre:"Voyage du Palais", tipo:"cena", lat:48.8641, lon:2.4137}
];

let map, userMarker;
let userLat = null;
let userLon = null;
let markers = [];

function distancia(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(lat1*Math.PI/180) *
      Math.cos(lat2*Math.PI/180) *
      Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function obtenerGPS() {
    document.getElementById("gpsStatus").textContent = "ğŸ“¡ Localizando...";
    
    navigator.geolocation.getCurrentPosition(pos => {
        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;

        document.getElementById("gpsStatus").textContent = "ğŸ“ UbicaciÃ³n actualizada";

        if (!map) {
            map = L.map('map').setView([userLat, userLon], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
                .addTo(map);
        } else {
            map.setView([userLat, userLon], 15);
        }

        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([userLat, userLon])
            .addTo(map)
            .bindPopup("ğŸ“ EstÃ¡s aquÃ­")
            .openPopup();

        render();
    }, () => {
        document.getElementById("gpsStatus").textContent = "âŒ No se pudo obtener ubicaciÃ³n";
    });
}

function render() {
    const tipo = tipoSel.value;
    const max = distanciaSel.value;
    lista.innerHTML = "";

    markers.forEach(m => map.removeLayer(m));
    markers = [];

    lugares.forEach(l => {
        const d = distancia(userLat, userLon, l.lat, l.lon);

        if ((tipo === "all" || l.tipo === tipo) && d * 60 <= max) {
            const m = L.marker([l.lat, l.lon])
                .addTo(map)
                .bindPopup(`${l.nombre}<br>ğŸš¶ ${d.toFixed(2)} km`);

            markers.push(m);

            lista.innerHTML += `
            <div class="card">
                <h3>${l.nombre}</h3>
                <p class="small">ğŸš¶ ${d.toFixed(2)} km</p>
                <a class="btn"
                   href="https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLon}&destination=${l.lat},${l.lon}&travelmode=walking"
                   target="_blank">Ir caminando</a>
            </div>`;
        }
    });
}

function toggleNight() {
    document.body.classList.toggle("night");
}

const tipoSel = document.getElementById("tipo");
const distanciaSel = document.getElementById("distancia");
const lista = document.getElementById("lista");

tipoSel.onchange = render;
distanciaSel.onchange = render;

// PWA
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
